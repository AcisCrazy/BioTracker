<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioTracker: Ultimate System</title>
    <style>
        /* --- EST√âTICA GENERAL --- */
        :root {
            --bg-color: #050a08;
            --panel-bg: #0f1a15;
            --accent: #00ffbf; /* Cian */
            --threat-color: #ff3333; /* Rojo */
            --safe-color: #4dff4d; /* Verde */
            --text: #e0f2e9;
            --highlight: #ffcc00; /* Amarillo */
            --font: 'Courier New', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: var(--font);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }

        /* Scanline Effect */
        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 10;
        }

        .game-container {
            width: 95%;
            max-width: 1000px;
            height: 700px;
            background-color: var(--panel-bg);
            border: 2px solid var(--accent);
            border-radius: 10px;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 191, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HUD --- */
        .header {
            display: flex; justify-content: space-between; padding: 15px;
            background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--accent);
            font-size: 1.1rem; font-weight: bold; color: var(--accent);
        }

        /* --- SCENES --- */
        .scene {
            flex-grow: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }
        .active { display: flex; }

        /* --- UI ELEMENTS --- */
        h1, h2 { margin-top: 0; text-shadow: 0 0 10px var(--accent); }
        
        .narrative-text {
            max-width: 700px; font-size: 1.1rem; line-height: 1.6; margin-bottom: 25px; text-align: left;
        }
        
        .scene-image {
            width: 100%; max-width: 500px; max-height: 250px; object-fit: cover;
            border: 2px solid var(--accent); border-radius: 5px; margin-bottom: 20px;
        }

        .btn {
            background: var(--accent); color: #000; border: none; padding: 12px 30px;
            font-family: var(--font); font-weight: bold; font-size: 1rem; cursor: pointer;
            margin: 10px; transition: transform 0.2s; text-transform: uppercase;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--accent); }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Special Buttons */
        .btn-lang { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-lang:hover { background: var(--accent); color: #000; }

        .btn-mode { background: transparent; border: 2px solid var(--highlight); color: var(--highlight); width: 300px; margin-top: 5px;}
        .btn-mode:hover { background: var(--highlight); color: #000; box-shadow: 0 0 20px var(--highlight); }

        .btn-safe { background: transparent; border: 2px solid var(--safe-color); color: var(--safe-color); width: 200px;}
        .btn-safe:hover { background: var(--safe-color); color: #000; }
        
        .btn-threat { background: transparent; border: 2px solid var(--threat-color); color: var(--threat-color); width: 200px;}
        .btn-threat:hover { background: var(--threat-color); color: #000; }

        /* --- TUTORIAL MINI-GAMES --- */
        .smart-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .smart-letter { 
            width: 50px; height: 50px; border: 1px solid #555; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.5rem; cursor: pointer; transition: 0.3s; 
        }
        .smart-letter.activated { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }

        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; }
        .map-cell { 
            width: 60px; height: 60px; border: 1px solid #333; cursor: pointer; 
            display: flex; justify-content: center; align-items: center;
            background-size: 60%; background-repeat: no-repeat; background-position: center;
        }
        .map-cell:hover { background-color: #222; }
        .map-cell.installed { background-color: rgba(0, 255, 191, 0.2); border-color: var(--accent); }

        /* --- MONITOR SIMULATION --- */
        .monitor-frame {
            width: 600px; height: 350px; border: 2px dashed var(--accent);
            position: relative; margin-bottom: 20px; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        .monitor-img { width: 100%; height: 100%; object-fit: cover; }
        
        .timer-bar {
            position: absolute; bottom: 0; left: 0; height: 8px; width: 100%;
            background-color: var(--threat-color); transition: width 0.1s linear;
        }

        .health-container { width: 200px; height: 20px; border: 1px solid var(--accent); background: #000; display: inline-block; vertical-align: middle; }
        .health-fill { width: 100%; height: 100%; background: var(--accent); transition: 0.3s; }
        .health-fill.critical { background: var(--threat-color); }

        .overlay-feedback {
            position: absolute; font-size: 3rem; font-weight: bold; 
            text-shadow: 2px 2px 0 #000; display: none; z-index: 5;
        }

        .high-score-box {
            position: absolute; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.7); border: 1px solid var(--highlight); 
            padding: 5px 10px; color: var(--highlight); font-size: 0.9rem;
        }

        /* --- ANIMATIONS --- */
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-2px, 2px); } 100% { transform: translate(0, 0); } }
        .shake { animation: shake 0.5s; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .flash-anim { animation: flash 0.2s; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .pulse-anim { animation: pulse 0.5s; color: var(--highlight); }

    </style>
</head>
<body>

    <div class="scanline"></div>

    <div class="game-container" id="game-container">
        <div class="header">
            <span id="hud-system">BIOTRACKER ICP</span>
            <span id="hud-phase">IDIOMA / LANGUAGE</span>
        </div>

        <div id="scene-lang" class="scene active">
            <h1>SYSTEM BOOT</h1>
            <p>Select Language / Seleccione Idioma</p>
            <div>
                <button class="btn btn-lang" onclick="setLanguage('es')">ESPA√ëOL</button>
                <button class="btn btn-lang" onclick="setLanguage('en')">ENGLISH</button>
            </div>
        </div>

        <div id="scene-intro" class="scene">
            <img src="Game_resources/intro.jpg" class="scene-image" alt="Intro">
            <div class="narrative-text" id="txt-intro-body"></div>
            
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn" id="btn-start-training" onclick="startMode('story')">START TRAINING</button>
                <button class="btn btn-mode" id="btn-start-free" onclick="startMode('free')">FREE MODE (ARCADE)</button>
            </div>
        </div>

        <div id="scene-smart" class="scene">
            <h2 id="title-smart">ESTRATEGIA</h2>
            <div class="narrative-text" id="txt-smart"></div>
            <div class="smart-container">
                <div class="smart-letter" onclick="clickSmart(this)">S</div>
                <div class="smart-letter" onclick="clickSmart(this)">M</div>
                <div class="smart-letter" onclick="clickSmart(this)">A</div>
                <div class="smart-letter" onclick="clickSmart(this)">R</div>
                <div class="smart-letter" onclick="clickSmart(this)">T</div>
            </div>
            <p id="smart-feedback" style="height: 20px; color: var(--highlight);">...</p>
            <button class="btn" id="btn-smart-next" disabled onclick="nextScene('scene-map')">CONFIRM</button>
        </div>

        <div id="scene-map" class="scene">
            <h2 id="title-map">INFRAESTRUCTURA</h2>
            <div class="narrative-text" id="txt-map"></div>
            <div class="map-grid" id="map-grid"></div>
            <p><span id="lbl-units">Unidades:</span> <span id="map-count" style="color:var(--accent)">0</span>/50</p>
            <button class="btn" id="btn-map-next" disabled onclick="nextScene('scene-ai')">ACTIVATE NETWORK</button>
        </div>

        <div id="scene-ai" class="scene">
            <h2 id="title-ai">INTELIGENCIA ARTIFICIAL</h2>
            <div class="narrative-text" id="txt-ai"></div>
            <div style="width: 400px; height: 250px; overflow: hidden; border: 2px solid var(--accent); margin-bottom: 10px;">
                <img src="Game_resources/venado.jpg" id="ai-img" style="width: 100%; height: 100%; object-fit: cover; filter: blur(20px);">
            </div>
            <input type="range" min="0" max="100" value="0" style="width: 300px; accent-color: var(--accent);" oninput="updateAI(this.value)">
            <p>Precision: <span id="ai-val">0</span>%</p>
            <button class="btn" id="btn-ai-next" disabled onclick="nextScene('scene-pre-sim')">VALIDATE MODEL</button>
        </div>

        <div id="scene-pre-sim" class="scene">
            <h1 style="color: var(--threat-color); font-size: 3rem;">‚ö†Ô∏è ALERTA ‚ö†Ô∏è</h1>
            <div class="narrative-text" id="txt-pre-sim" style="text-align: center;"></div>
            <button class="btn" onclick="launchSimulation()" id="btn-launch">LAUNCH LIVE MONITOR</button>
        </div>

        <div id="scene-sim" class="scene">
            <div class="high-score-box">
                RECORD: <span id="high-score-val">0</span>
            </div>

            <div style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold;">
                <div><span id="lbl-forest">INTEGRIDAD:</span> <div class="health-container"><div id="health-bar" class="health-fill"></div></div></div>
                <div><span id="lbl-score">SCORE:</span> <span id="score-val" style="color: var(--accent);">0</span></div>
            </div>

            <div class="monitor-frame">
                <img id="sim-img" src="" class="monitor-img">
                <div id="sim-timer" class="timer-bar"></div>
                <div id="sim-overlay" class="overlay-feedback"></div>
            </div>

            <div style="display: flex; gap: 20px;">
                <button class="btn btn-safe" id="btn-safe" onclick="playerAction('safe')">FAUNA</button>
                <button class="btn btn-threat" id="btn-threat" onclick="playerAction('threat')">AMENAZA</button>
            </div>
        </div>

        <div id="scene-end" class="scene">
            <h1 id="end-title">MISSION REPORT</h1>
            <img src="Game_resources/final.jpg" class="scene-image" style="max-width: 400px;">
            <div class="narrative-text" id="txt-end"></div>
            <h2 id="final-score-display" style="color: var(--accent);"></h2>
            <p id="new-record-msg" style="color: var(--highlight); font-weight: bold; display: none;">üèÜ NEW HIGH SCORE! üèÜ</p>
            <button class="btn" onclick="location.reload()">MAIN MENU</button>
        </div>

    </div>

    <script>
        /* --- CONFIGURACI√ìN DE DATOS --- */
        let curLang = 'es';
        let curMode = 'story'; // 'story' o 'free'
        
        // Variables de Juego
        let smartProgress = 0;
        let mapUnits = 0;
        let score = 0;
        let health = 100;
        let gameActive = false;
        let currentImageObj = null;
        let timerInterval = null;
        let timeLeft = 100;
        
        // Variables Modo Libre
        let decayRate = 1.0; // Velocidad inicial de la barra
        let roundCounter = 0; // Para subir dificultad

        // DB Im√°genes
        const db = [
            { src: 'Game_resources/venado.jpg', type: 'safe' },
            { src: 'Game_resources/ave.jpg', type: 'safe' },
            { src: 'Game_resources/zorro.jpg', type: 'safe' },
            { src: 'Game_resources/cazador.jpg', type: 'threat' },
            { src: 'Game_resources/incendio.jpg', type: 'threat' },
            { src: 'Game_resources/basura.jpg', type: 'threat' }
        ];

        // Textos
        const texts = {
            es: {
                hudPhase: "ENTRENAMIENTO",
                hudPhaseSim: "MONITOREO EN VIVO",
                hudPhaseFree: "MODO LIBRE (INFINITO)",
                btnStart: "TUTORIAL DE ENTRENAMIENTO",
                btnFree: "MODO LIBRE (VELOCIDAD PROGRESIVA)",
                introBody: "Bienvenido a BioTracker. El Bosque de La Primavera sufre por caza furtiva, incendios y basura. Estas amenazas destruyen el h√°bitat. Tu misi√≥n: Usar tecnolog√≠a para identificarlos y protegerlos.",
                titleSmart: "OBJETIVOS S.M.A.R.T.",
                txtSmart: "Haz clic en las siglas para cargar el protocolo estrat√©gico.",
                smartWords: ["Espec√≠fico", "Medible", "Alcanzable", "Relevante", "Temporal"],
                btnConfirm: "CONFIRMAR",
                titleMap: "INFRAESTRUCTURA",
                txtMap: "Meta: Instalar 50 SENSORES. Haz clic en la cuadr√≠cula.",
                lblUnits: "Unidades:",
                btnActivate: "ACTIVAR RED",
                titleAI: "CALIBRACI√ìN IA",
                txtAI: "Entrena a la IA deslizando el control hasta superar el 90% de precisi√≥n.",
                btnValidate: "VALIDAR MODELO",
                txtPreSim: "ENTRENAMIENTO COMPLETADO.\n\nALERTA: Diferencia entre FAUNA (Seguro) y AMENAZAS (Cazadores, Fuego, Basura).\n\nHistoria: 10 rondas.\nModo Libre: Infinito.",
                btnLaunch: "INICIAR MONITOR",
                lblForest: "INTEGRIDAD",
                lblScore: "PUNTOS",
                btnSafe: "FAUNA (SEGURO)",
                btnThreat: "AMENAZA (ALERTA)",
                endWinTitle: "MISI√ìN CUMPLIDA",
                endLoseTitle: "SISTEMA COLAPSADO",
                endWinMsg: "Excelente. Detectaste las amenazas a tiempo y el bosque est√° seguro. BioTracker demuestra que la tecnolog√≠a es clave.",
                endLoseMsg: "El bosque ha sufrido demasiados da√±os. En la vida real, no hay 'Reiniciar'. La conservaci√≥n requiere precisi√≥n.",
                overlaySafe: "REGISTRADO",
                overlayThreat: "NEUTRALIZADO",
                overlayFail: "ERROR",
                overlayMiss: "¬°DA√ëO!",
                overlaySpeed: "¬°VELOCIDAD AUMENTADA!"
            },
            en: {
                hudPhase: "TRAINING MODE",
                hudPhaseSim: "LIVE MONITORING",
                hudPhaseFree: "FREE MODE (ENDLESS)",
                btnStart: "START TRAINING TUTORIAL",
                btnFree: "FREE MODE (SPEED RUSH)",
                introBody: "Welcome to BioTracker. La Primavera Forest suffers from poaching, fires, and trash. These threats destroy the habitat. Your mission: Use tech to protect them.",
                titleSmart: "S.M.A.R.T. GOALS",
                txtSmart: "Click the letters to load the strategic protocol.",
                smartWords: ["Specific", "Measurable", "Achievable", "Relevant", "Time-bound"],
                btnConfirm: "CONFIRM",
                titleMap: "INFRASTRUCTURE",
                txtMap: "Goal: Install 50 SENSORS. Click the grid.",
                lblUnits: "Units:",
                btnActivate: "ACTIVATE NETWORK",
                titleAI: "AI CALIBRATION",
                txtAI: "Train the AI by sliding the control until precision exceeds 90%.",
                btnValidate: "VALIDATE MODEL",
                txtPreSim: "TRAINING COMPLETE.\n\nALERT: Distinguish between WILDLIFE (Safe) and THREATS (Fire, Trash, Poachers).\n\nStory: 10 rounds.\nFree Mode: Endless.",
                btnLaunch: "START MONITOR",
                lblForest: "INTEGRITY",
                lblScore: "SCORE",
                btnSafe: "WILDLIFE (SAFE)",
                btnThreat: "THREAT (ALERT)",
                endWinTitle: "MISSION ACCOMPLISHED",
                endLoseTitle: "SYSTEM COLLAPSED",
                endWinMsg: "Great job. You detected threats in time. BioTracker proves technology is key to conservation.",
                endLoseMsg: "The forest suffered too much damage. In real life, there is no 'Restart'. Conservation requires precision.",
                overlaySafe: "LOGGED",
                overlayThreat: "NEUTRALIZED",
                overlayFail: "ERROR",
                overlayMiss: "DAMAGE!",
                overlaySpeed: "SPEED UP!"
            }
        };

        /* --- FUNCIONES DE INICIO --- */
        function setLanguage(lang) {
            curLang = lang;
            const t = texts[lang];
            
            // Ocultar botones idioma
            document.querySelectorAll('.btn-lang').forEach(b => b.style.display = 'none'); 
            
            // Cargar Textos HUD y Menu
            document.getElementById('hud-phase').innerText = t.hudPhase;
            document.getElementById('txt-intro-body').innerText = t.introBody;
            document.getElementById('btn-start-training').innerText = t.btnStart;
            document.getElementById('btn-start-free').innerText = t.btnFree;
            
            // Cargar Textos Tutorial
            document.getElementById('title-smart').innerText = t.titleSmart;
            document.getElementById('txt-smart').innerText = t.txtSmart;
            document.getElementById('btn-smart-next').innerText = t.btnConfirm;
            document.getElementById('title-map').innerText = t.titleMap;
            document.getElementById('txt-map').innerText = t.txtMap;
            document.getElementById('lbl-units').innerText = t.lblUnits;
            document.getElementById('btn-map-next').innerText = t.btnActivate;
            document.getElementById('title-ai').innerText = t.titleAI;
            document.getElementById('txt-ai').innerText = t.txtAI;
            document.getElementById('btn-ai-next').innerText = t.btnValidate;
            
            // Textos Simulaci√≥n
            document.getElementById('txt-pre-sim').innerText = t.txtPreSim;
            document.getElementById('btn-launch').innerText = t.btnLaunch;
            document.getElementById('lbl-forest').innerText = t.lblForest;
            document.getElementById('lbl-score').innerText = t.lblScore;
            document.getElementById('btn-safe').innerText = t.btnSafe;
            document.getElementById('btn-threat').innerText = t.btnThreat;

            nextScene('scene-intro');
        }

        function nextScene(id) {
            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'scene-map') initMap();
        }

        /* --- SELECCI√ìN DE MODO --- */
        function startMode(mode) {
            curMode = mode;
            
            // Cargar Record
            const savedScore = localStorage.getItem('biotracker_highscore') || 0;
            document.getElementById('high-score-val').innerText = savedScore;

            if (mode === 'story') {
                // Story: Va al tutorial primero
                nextScene('scene-smart');
            } else {
                // Free: Salta directo a la acci√≥n (Pre-Sim)
                nextScene('scene-pre-sim');
            }
        }

        /* --- TUTORIAL (SMART, MAP, AI) --- */
        // 1. SMART
        function clickSmart(el) {
            if(el.classList.contains('activated')) return;
            el.classList.add('activated');
            smartProgress++;
            const wordIndex = Array.from(el.parentNode.children).indexOf(el);
            document.getElementById('smart-feedback').innerText = texts[curLang].smartWords[wordIndex];
            if(smartProgress === 5) {
                document.getElementById('btn-smart-next').disabled = false;
                document.getElementById('smart-feedback').innerText = "OK";
            }
        }
        // 2. MAPA
        function initMap() {
            const grid = document.getElementById('map-grid');
            grid.innerHTML = ''; 
            for(let i=0; i<10; i++) {
                let d = document.createElement('div');
                d.className = 'map-cell';
                d.onclick = function() {
                    if(!this.classList.contains('installed')) {
                        this.classList.add('installed');
                        this.style.backgroundImage = "url('Game_resources/icon.png')";
                        mapUnits += 5;
                        document.getElementById('map-count').innerText = mapUnits;
                        if(mapUnits === 50) document.getElementById('btn-map-next').disabled = false;
                    }
                };
                grid.appendChild(d);
            }
        }
        // 3. IA
        function updateAI(val) {
            document.getElementById('ai-val').innerText = val;
            let blur = 20 - (val / 5);
            if(blur < 0) blur = 0;
            document.getElementById('ai-img').style.filter = `blur(${blur}px)`;
            if(val > 90) document.getElementById('btn-ai-next').disabled = false;
            else document.getElementById('btn-ai-next').disabled = true;
        }

        /* --- SIMULACI√ìN (GAMEPLAY) --- */
        function launchSimulation() {
            // Reiniciar variables
            score = 0;
            health = 100;
            gameActive = true;
            roundCounter = 0;
            
            // Configurar dificultad inicial
            if(curMode === 'free') {
                decayRate = 0.8; // Comienza un poco m√°s lento, pero subir√°
                document.getElementById('hud-phase').innerText = texts[curLang].hudPhaseFree;
            } else {
                decayRate = 1.0; // Velocidad fija para historia
                document.getElementById('hud-phase').innerText = texts[curLang].hudPhaseSim;
            }

            updateHUD();
            nextScene('scene-sim');
            startRound();
        }

        function startRound() {
            if(!gameActive) return;
            
            // Imagen Random
            const rand = Math.floor(Math.random() * db.length);
            currentImageObj = db[rand];
            
            const imgEl = document.getElementById('sim-img');
            imgEl.src = currentImageObj.src;
            imgEl.style.animation = 'none';
            imgEl.offsetHeight; 
            imgEl.style.animation = 'flash-anim 0.2s';

            // Reset Timer
            timeLeft = 100;
            document.getElementById('sim-timer').style.width = "100%";
            
            if(timerInterval) clearInterval(timerInterval);
            
            // Timer Loop
            timerInterval = setInterval(() => {
                if(!gameActive) return;
                timeLeft -= decayRate; // Usa la variable de dificultad
                document.getElementById('sim-timer').style.width = timeLeft + "%";
                if(timeLeft <= 0) handleTimeout();
            }, 30);
        }

        function playerAction(action) {
            if(!gameActive) return;
            clearInterval(timerInterval);
            const t = texts[curLang];

            if(action === currentImageObj.type) {
                // ACIERTO
                score += 100;
                let txt = action === 'safe' ? t.overlaySafe : t.overlayThreat;
                let col = action === 'safe' ? 'var(--safe-color)' : 'var(--accent)';
                showOverlay(txt, col);

                // Mec√°nica Modo Libre: Aumentar Velocidad
                if(curMode === 'free') {
                    roundCounter++;
                    // Cada 5 aciertos, sube la velocidad
                    if(roundCounter % 5 === 0) {
                        decayRate += 0.2; // M√°s r√°pido
                        if(decayRate > 3.5) decayRate = 3.5; // Tope de velocidad
                        showOverlay(t.overlaySpeed, "var(--highlight)");
                    }
                }

            } else {
                // ERROR
                damage(20);
                showOverlay(t.overlayFail, "var(--threat-color)");
            }
            updateHUD();
            
            checkEndConditions();
        }

        function handleTimeout() {
            clearInterval(timerInterval);
            const t = texts[curLang];
            if(currentImageObj.type === 'threat') {
                damage(30);
                showOverlay(t.overlayMiss, "var(--threat-color)");
            } else {
                showOverlay("TIMEOUT", "yellow");
            }
            updateHUD();
            checkEndConditions();
        }

        function checkEndConditions() {
            if(health <= 0) {
                setTimeout(() => endGame(false), 1000);
                return;
            }

            // En modo Historia, ganamos al llegar a 1000pts
            if(curMode === 'story' && score >= 1000) {
                setTimeout(() => endGame(true), 1000);
            } else {
                // En modo libre, o si no hemos ganado en historia, sigue jugando
                setTimeout(startRound, 800);
            }
        }

        function damage(amount) {
            health -= amount;
            if(health < 0) health = 0;
            document.getElementById('game-container').classList.add('shake');
            setTimeout(()=> document.getElementById('game-container').classList.remove('shake'), 500);
        }

        function showOverlay(txt, col) {
            const ov = document.getElementById('sim-overlay');
            ov.innerText = txt;
            ov.style.color = col;
            ov.style.display = 'block';
            
            // Animaci√≥n pulso si es Speed Up
            if(txt.includes("SPEED")) ov.classList.add('pulse-anim');
            else ov.classList.remove('pulse-anim');

            setTimeout(() => ov.style.display = 'none', 700);
        }

        function updateHUD() {
            document.getElementById('score-val').innerText = score;
            const hBar = document.getElementById('health-bar');
            hBar.style.width = health + "%";
            if(health < 40) hBar.classList.add('critical');
            else hBar.classList.remove('critical');
        }

        function endGame(win) {
            gameActive = false;
            nextScene('scene-end');
            const t = texts[curLang];
            
            // Guardar High Score (Solo en Modo Libre)
            if(curMode === 'free') {
                const savedScore = localStorage.getItem('biotracker_highscore') || 0;
                if (score > savedScore) {
                    localStorage.setItem('biotracker_highscore', score);
                    document.getElementById('new-record-msg').style.display = 'block';
                } else {
                    document.getElementById('new-record-msg').style.display = 'none';
                }
            }

            document.getElementById('end-title').innerText = win ? t.endWinTitle : t.endLoseTitle;
            document.getElementById('end-title').style.color = win ? 'var(--safe-color)' : 'var(--threat-color)';
            
            // Mensaje personalizado por modo
            if(curMode === 'free') {
                document.getElementById('txt-end').innerText = "Modo Libre finalizado. ¬°Buen intento agente!";
            } else {
                document.getElementById('txt-end').innerText = win ? t.endWinMsg : t.endLoseMsg;
            }
            
            document.getElementById('final-score-display').innerText = `${t.lblScore}: ${score}`;
        }

    </script>
</body>
</html>